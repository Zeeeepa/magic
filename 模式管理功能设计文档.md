# 模式管理功能设计文档

## 1. 需求概述

### 1.1 功能描述
模式管理是一个平台管理管理员专用功能，用于管理AI模型的分组和分配策略。通过模式可以将不同的AI模型组织到不同的分组中，并支持多种分配策略。

### 1.2 核心功能
- **模式管理**：创建、编辑、删除模式（默认模式不可删除）
- **分组管理**：在模式下创建分组，管理分组的基本信息
- **模型分配**：将模型分配到不同分组中
- **分配策略**：
  - 自定义配置：手动配置模型分组
  - 跟随其他模式：动态跟随指定模式的配置
- **重置功能**：可重置为默认模式配置（前端实现）

### 1.3 权限控制
- 仅平台管理管理员可访问此功能
- 基于组织代码进行数据隔离

### 1.4 模型数据源
从现有的 `service_provider_models` 表查询当前组织下 `status=1` 且 `deleted_at IS NULL` 的模型数据。

## 2. 数据库设计

### 2.1 模式管理表 (`magic_model_modes`)

```sql
CREATE TABLE `magic_model_modes` (
    `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
    `name` varchar(100) NOT NULL DEFAULT '' COMMENT '模式名称',
    `identifier` varchar(50) NOT NULL DEFAULT '' COMMENT '模式标识，唯一',
    `icon` varchar(255) NOT NULL DEFAULT '' COMMENT '模式图标',
    `color` varchar(10) NOT NULL DEFAULT '' COMMENT '模式颜色',
    `description` text NOT NULL COMMENT '模式描述',
    `is_default` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否默认模式 0:否 1:是',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态 0:禁用 1:启用',
    `distribution_type` tinyint(1) NOT NULL DEFAULT 1 COMMENT '分配方式 1:自定义配置 2:跟随其他模式',
    `follow_mode_id` bigint(20) unsigned NOT NULL DEFAULT 0 COMMENT '跟随的模式ID，0表示不跟随',
    `restricted_mode_identifiers` json NOT NULL COMMENT '限制的模式标识数组',
    `organization_code` varchar(32) NOT NULL DEFAULT '' COMMENT '组织代码',
    `creator_id` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人ID',
    `created_at` timestamp NULL DEFAULT NULL,
    `updated_at` timestamp NULL DEFAULT NULL,
    `deleted_at` timestamp NULL DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='模式管理表';
```

**字段说明：**
- `identifier`：模式的唯一标识符，用于前端识别特定模式
- `is_default`：标识是否为默认模式，每个组织有且仅有一个默认模式
- `distribution_type`：分配策略类型
- `follow_mode_id`：当分配策略为"跟随其他模式"时，指定跟随的目标模式ID
- `restricted_mode_identifiers`：限制的模式标识数组，用于控制哪些模式可以被跟随

### 2.2 分组管理表 (`magic_model_groups`)

```sql
CREATE TABLE `magic_model_groups` (
    `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
    `mode_id` bigint(20) unsigned NOT NULL DEFAULT 0 COMMENT '模式ID',
    `name` varchar(100) NOT NULL DEFAULT '' COMMENT '分组名称',
    `icon` varchar(255) NOT NULL DEFAULT '' COMMENT '分组图标',
    `color` varchar(10) NOT NULL DEFAULT '' COMMENT '分组颜色',
    `description` text NOT NULL COMMENT '分组描述',
    `sort` int NOT NULL DEFAULT 0 COMMENT '排序权重',
    `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态 0:禁用 1:启用',
    `organization_code` varchar(32) NOT NULL DEFAULT '' COMMENT '组织代码',
    `creator_id` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人ID',
    `created_at` timestamp NULL DEFAULT NULL,
    `updated_at` timestamp NULL DEFAULT NULL,
    `deleted_at` timestamp NULL DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='模式分组表';
```

**字段说明：**
- `mode_id`：所属模式的ID
- `sort`：分组排序权重，用于控制分组在界面中的显示顺序
- `icon` 和 `color`：分组的图标和颜色，用于前端展示

### 2.3 模型分组关联表 (`magic_model_group_relations`)

```sql
CREATE TABLE `magic_model_group_relations` (
    `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
    `mode_id` bigint(20) unsigned NOT NULL DEFAULT 0 COMMENT '模式ID',
    `group_id` bigint(20) unsigned NOT NULL DEFAULT 0 COMMENT '分组ID',
    `model_id` bigint(20) unsigned NOT NULL DEFAULT 0 COMMENT '模型ID',
    `sort` int NOT NULL DEFAULT 0 COMMENT '排序权重',
    `organization_code` varchar(32) NOT NULL DEFAULT '' COMMENT '组织代码',
    `created_at` timestamp NULL DEFAULT NULL,
    `updated_at` timestamp NULL DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='模型分组关联表';
```

**字段说明：**
- `mode_id`：所属模式ID（冗余字段，便于查询优化）
- `group_id`：分组ID
- `model_id`：模型ID，关联 `service_provider_models` 表的 `id` 字段
- `sort`：模型在分组内的排序权重

## 3. 目录结构设计

基于现有的DDD架构，模式管理功能的目录结构如下：

```
app/
├── Application/
│   └── Mode/
│       ├── Service/
│       │   ├── ModeAppService.php              # 模式应用服务
│       │   └── ModeGroupAppService.php         # 分组应用服务
│       └── Assembler/
│           └── ModeAssembler.php               # 模式组装器(负责实体转DTO)
├── Domain/
│   └── Mode/
│       ├── Entity/
│       │   ├── ModeEntity.php                  # 模式实体
│       │   ├── ModeGroupEntity.php             # 分组实体
│       │   └── ModeGroupRelationEntity.php     # 关联实体
│       ├── Service/
│       │   ├── ModeDomainService.php           # 模式领域服务
│       │   └── ModeGroupDomainService.php      # 分组领域服务
│       ├── Repository/
│       │   ├── Facade/
│       │   │   ├── ModeRepositoryInterface.php      # 模式仓储接口
│       │   │   ├── ModeGroupRepositoryInterface.php # 分组仓储接口
│       │   │   └── ModeGroupRelationRepositoryInterface.php # 关联仓储接口
│       │   └── Persistence/
│       │       ├── ModeRepository.php               # 模式仓储实现
│       │       ├── ModeGroupRepository.php          # 分组仓储实现
│       │       ├── ModeGroupRelationRepository.php  # 关联仓储实现
│       │       └── Model/
│       │           ├── ModeModel.php                # 模式数据模型
│       │           ├── ModeGroupModel.php           # 分组数据模型
│       │           └── ModeGroupRelationModel.php   # 关联数据模型
│       └── ValueObject/
│           └── DistributionType.php            # 分配类型枚举
└── Interfaces/
    └── Mode/
        ├── Facade/
        │   └── ModeApi.php                     # 模式API控制器
        ├── DTO/
        │   ├── Request/
        │   │   ├── CreateModeRequest.php            # 创建模式请求对象
        │   │   ├── UpdateModeRequest.php            # 更新模式请求对象
        │   │   ├── CreateModeGroupRequest.php       # 创建分组请求对象
        │   │   ├── UpdateModeGroupRequest.php       # 更新分组请求对象
        │   │   └── ConfigModeGroupRequest.php       # 配置分组请求对象
        │   └── Response/
        │       ├── ModeListResponseDTO.php          # 模式列表响应DTO
        │       ├── ModeDetailResponseDTO.php        # 模式详情响应DTO
        │       ├── ModeGroupListResponseDTO.php     # 分组列表响应DTO
        │       └── ModeConfigurationResponseDTO.php # 模式配置响应DTO

config/
└── routes-v1/
    └── mode.php                                # 模式管理路由

migrations/
├── 2025_08_22_000001_create_magic_model_modes_table.php           # 模式表迁移
├── 2025_08_22_000002_create_magic_model_groups_table.php          # 分组表迁移
└── 2025_08_22_000003_create_magic_model_group_relations_table.php # 关联表迁移
```

## 4. 业务逻辑设计

### 4.1 默认模式初始化

在数据库迁移过程中，自动为每个现有组织创建默认模式：

```php
private function initializeDefaultMode(): void
{
    // 为每个现有组织创建默认模式
    $organizations = Db::table('magic_organizations')
        ->where('status', 1)
        ->whereNull('deleted_at')
        ->pluck('magic_organization_code');

    foreach ($organizations as $orgCode) {
        Db::table('magic_model_modes')->insert([
            'name' => '默认模式',
            'identifier' => 'default',
            'description' => '系统默认模式，用于创建时初始化模式及重置模式中的配置',
            'is_default' => 1,
            'status' => 1,
            'distribution_type' => 1,
            'follow_mode_id' => 0,
            'restricted_mode_identifiers' => json_encode([]),
            'organization_code' => $orgCode,
            'creator_id' => 'system',
            'created_at' => now(),
            'updated_at' => now(),
        ]);
    }
}
```

### 4.2 跟随模式业务逻辑

**设计原则：** 跟随模式采用动态读取策略，不存储重复数据。

**实现方式：**
1. 当模式A设置为跟随模式B（`distribution_type=2`, `follow_mode_id=B的ID`）
2. 查询模式A的配置时，自动读取模式B的分组和模型配置
3. 在业务层面实现配置继承，避免数据冗余和同步问题

**查询逻辑：**
```php
public function getModeConfiguration($modeId) 
{
    $mode = $this->getModeById($modeId);
    
    if ($mode->distribution_type === 2 && $mode->follow_mode_id > 0) {
        // 跟随其他模式，递归获取被跟随模式的配置
        return $this->getModeConfiguration($mode->follow_mode_id);
    }
    
    // 自定义配置，直接返回当前模式的配置
    return $this->getOwnModeConfiguration($modeId);
}
```

### 4.3 模型数据源

模型数据来源于现有的 `service_provider_models` 表：

**查询条件：**
- `organization_code = 当前组织代码`
- `status = 1`（启用状态）
- `deleted_at IS NULL`（未删除）

**查询示例：**
```php
public function getAvailableModels($organizationCode) 
{
    return $this->providerModelRepository->getOrganizationAvailableModels(
        $organizationCode, 
        null // category 参数，null表示获取所有类型模型
    );
}
```

## 5. API接口设计

### 5.1 模式管理接口

**5.1.1 获取模式列表**
- **路由：** `GET /api/v1/modes`
- **权限：** 平台管理管理员
- **响应：** 返回当前组织下的所有模式列表

**5.1.2 创建模式**
- **路由：** `POST /api/v1/modes`
- **权限：** 平台管理管理员
- **参数：** 模式名称、标识、图标、颜色、描述、分配策略等

**5.1.3 更新模式**
- **路由：** `PUT /api/v1/modes/{id}`
- **权限：** 平台管理管理员
- **限制：** 默认模式不可删除，但可以编辑

**5.1.4 删除模式**
- **路由：** `DELETE /api/v1/modes/{id}`
- **权限：** 平台管理管理员
- **限制：** 默认模式不可删除

### 5.2 分组管理接口

**5.2.1 获取模式分组配置**
- **路由：** `GET /api/v1/modes/{id}/groups`
- **权限：** 平台管理管理员
- **功能：** 获取指定模式的分组和模型配置（支持跟随模式）

**5.2.2 配置模式分组**
- **路由：** `POST /api/v1/modes/{id}/groups`
- **权限：** 平台管理管理员
- **功能：** 批量配置模式的分组和模型分配

**5.2.3 重置为默认模式**
- **路由：** `POST /api/v1/modes/{id}/reset`
- **权限：** 平台管理管理员
- **功能：** 将指定模式重置为默认模式的配置

## 6. 实现要点

### 6.1 数据一致性
- 所有表都包含 `organization_code` 字段，确保多租户数据隔离
- 关联关系通过业务逻辑维护，不使用数据库外键约束
- 使用软删除机制，支持数据恢复

### 6.2 性能优化
- 跟随模式的配置查询支持递归，但需要防止循环引用
- 模式配置数据可以考虑缓存，提升查询性能
- 模型数据源复用现有的查询接口和缓存机制

### 6.3 扩展性
- `restricted_mode_identifiers` 字段支持限制可跟随的模式
- 分配类型枚举支持未来新增分配策略
- 分组和模型的排序字段支持灵活的展示顺序控制

### 6.4 安全性
- 严格的权限控制，仅平台管理管理员可访问
- 基于组织代码的数据隔离
- 输入参数验证和SQL注入防护

## 7. 迁移文件示例

### 7.1 创建模式表迁移

```php
<?php

use Hyperf\Database\Schema\Schema;
use Hyperf\Database\Schema\Blueprint;
use Hyperf\Database\Migrations\Migration;
use Hyperf\DbConnection\Db;

class CreateMagicModelModesTable extends Migration
{
    public function up(): void
    {
        Schema::create('magic_model_modes', function (Blueprint $table) {
            $table->bigIncrements('id');
            $table->string('name', 100)->default('')->comment('模式名称');
            $table->string('identifier', 50)->default('')->comment('模式标识，唯一');
            $table->string('icon', 255)->default('')->comment('模式图标');
            $table->string('color', 10)->default('')->comment('模式颜色');
            $table->text('description')->comment('模式描述');
            $table->tinyInteger('is_default')->default(0)->comment('是否默认模式 0:否 1:是');
            $table->tinyInteger('status')->default(1)->comment('状态 0:禁用 1:启用');
            $table->tinyInteger('distribution_type')->default(1)->comment('分配方式 1:自定义配置 2:跟随其他模式');
            $table->bigInteger('follow_mode_id')->unsigned()->default(0)->comment('跟随的模式ID，0表示不跟随');
            $table->json('restricted_mode_identifiers')->comment('限制的模式标识数组');
            $table->string('organization_code', 32)->default('')->comment('组织代码');
            $table->string('creator_id', 64)->default('')->comment('创建人ID');
            $table->timestamps();
            $table->softDeletes();
        });

        // 初始化默认模式
        $this->initializeDefaultMode();
    }

    public function down(): void
    {
        Schema::dropIfExists('magic_model_modes');
    }

    private function initializeDefaultMode(): void
    {
        // 为每个现有组织创建默认模式
        $organizations = Db::table('magic_organizations')
            ->where('status', 1)
            ->whereNull('deleted_at')
            ->pluck('magic_organization_code');

        foreach ($organizations as $orgCode) {
            Db::table('magic_model_modes')->insert([
                'name' => '默认模式',
                'identifier' => 'default',
                'description' => '系统默认模式，用于创建时初始化模式及重置模式中的配置',
                'is_default' => 1,
                'status' => 1,
                'distribution_type' => 1,
                'follow_mode_id' => 0,
                'restricted_mode_identifiers' => json_encode([]),
                'organization_code' => $orgCode,
                'creator_id' => 'system',
                'created_at' => now(),
                'updated_at' => now(),
            ]);
        }
    }
}
```

这个设计文档涵盖了模式管理功能的完整设计思路，符合现有系统的架构模式，可以作为开发实现的指导文档。